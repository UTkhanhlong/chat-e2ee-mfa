import { Response } from 'express'; import { z } from 'zod'; import qrcode from 'qrcode'; import speakeasy from 'speakeasy'; import { memoryStorage as db } from '../../data/storage.memory'; const codeSchema=z.object({code:z.string()}); export const MfaController={ totpSetup:async(req:any,res:Response)=>{const secret=speakeasy.generateSecret({name:`Chat-E2EE-MFA (${req.user})`}); const png=await qrcode.toDataURL(secret.otpauth_url); await db.setTOTPSecret(req.user,secret.base32); res.json({otpauth:secret.otpauth_url,qrcode:png});}, totpVerify:async(req:any,res:Response)=>{const {code}=codeSchema.parse(req.body); const mfa=await db.getMFA(req.user); if(!mfa?.totp_secret) return res.status(400).json({error:'no secret'}); const ok=speakeasy.totp.verify({secret:mfa.totp_secret,encoding:'base32',token:code,window:1}); if(!ok) return res.status(400).json({error:'invalid code'}); const backups=Array.from({length:10},()=>Math.random().toString(36).slice(2,8).toUpperCase()); await db.enableTOTP(req.user,backups); res.json({enabled:true,backups});}, totpLogin:async(req:any,res:Response)=>{const {code}=codeSchema.parse(req.body); const mfa=await db.getMFA(req.user); if(!mfa?.totp_enabled) return res.status(400).json({error:'not enabled'}); let ok=false; if(/^[A-Z0-9]{6}$/.test(code)) ok=speakeasy.totp.verify({secret:mfa.totp_secret!,encoding:'base32',token:code,window:1}); if(!ok) ok=await db.consumeBackup(req.user,code); if(!ok) return res.status(400).json({error:'invalid'}); res.json({ok:true});} };
